# Helper Rakefile for ndss project
# Author: Santa Zhang


desc "Report status"
task "report" do
  puts "TODO report status"
end

desc "Check coding style"
task "checkstyle" do
  puts "TODO check coding style"
end

desc "Generate Makefile & include files"
task "gen" do
  # gen make file
  File.open("Makefile", "w") do |mf|
    mf.write <<MF_EOF
# WARNING! This file is automatically generated by "rake gen".
# WARNING! Any modification to it would be lost after another "rake gen" operation!

# Automatically generated at #{Time.now}

CC=gcc
CFLAGS=-Wall -O2

all: prepare ndss

prepare:
	mkdir -p bin
	mkdir -p obj

ndss:

test:

clean:
	rm -rf bin
	rm -rf obj

MF_EOF
  end

  # gen include files
  `mkdir -p include`
  File.open("include/README", "w") do |f|
    f.write <<INCLUDE_README
The .h files in this folder is intended for development using ndss library. Core
component of ndss SHOULD NOT use any of them!

All files in this folder is automatically generated by "rake gen". Any modification
to these files would be lost after another "rake gen" operation!

Automatically generated at #{Time.now}
INCLUDE_README
  end

  File.open("include/xdk.h", "w") do |f|
    include_list = ""

    Dir.entries("xdk").each do |e|
      # NOTE could blacklist unwanted .h files
      include_list += "#include \"#{e}\"\n" if e =~ /\.h$/
    end

    f.write <<INCLUDE_XDK
// WARNING! This file is automatically generated by "rake gen".
// WARNING! Any modification to it would be lost after another "rake gen" operation!

// Automatically generated at #{Time.now}

#ifndef XDK_H_
#define XDK_H_

#{include_list}
#endif
INCLUDE_XDK
  end

  File.open("include/ndss.h", "w") do |f|
    include_list = ""

    Dir.entries("core").each do |e|
      # NOTE could blacklist unwanted .h files
      include_list += "#include \"#{e}\"\n" if e =~ /\.h$/
    end

    f.write <<INCLUDE_NDSS
// WARNING! This file is automatically generated by "rake gen".
// WARNING! Any modification to it would be lost after another "rake gen" operation!

// Automatically generated at #{Time.now}

#ifndef NDSS_H_
#define NDSS_H_

#{include_list}
#endif
INCLUDE_NDSS
  end

end


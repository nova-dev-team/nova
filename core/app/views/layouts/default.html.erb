<html>
<head>
<title>Welcome, '<%=h current_user.name != "" ? current_user.name : current_user.login %>'</title>

<link href="/stylesheets/custom_buttons/custom_buttons.css" rel="stylesheet" type="text/css" />
<link href="/stylesheets/lavalamp/lavalamp.css" rel="stylesheet" type="text/css" />

<link href="/stylesheets/jquery-ui/ui.all.css" rel="stylesheet" type="text/css" />


<link href="/stylesheets/jquery-ui/theme.flick.css" rel="stylesheet" type="text/css" />

<!-- For dialogs -->
<link href="/stylesheets/jquery-ui/theme.my.mac.dialog.css" rel="stylesheet" type="text/css" />

<!-- Older version of jQuery
<script type="text/javascript" src="/javascripts/jquery-1.2.6.js"></script>
<script type="text/javascript" src="/javascripts/jquery.ui.all-1.5.2.js"></script>
-->


<script type="text/javascript" src="/javascripts/jquery-1.3.2.js"></script>
<script type="text/javascript" src="/javascripts/jquery.easing.min.js"></script>
<script type="text/javascript" src="/javascripts/jquery-ui-1.7.2.custom.min.js"></script>

<script type="text/javascript" src="/javascripts/jquery.layout.js"></script>
<script type="text/javascript" src="/javascripts/jquery.lavalamp.js"></script>


<!-- IE PNG bug fix -->
<style type="text/css">
img, div, a, input { behavior: url(/stylesheets/iepngfix.htc) }
</style>
<script type="text/javascript" src="/javascripts/iepngfix_tilebg.js"></script>


<script type="text/javascript" src="/javascripts/jquery.jgrowl.js"></script>
<link href="/stylesheets/jgrowl/jquery.jgrowl.css" rel="stylesheet" type="text/css" />

<style type="text/css" media="screen">

body {
  position: absolute;
  margin: 0;
  margin-bottom: 25px;
  padding: 0;
  font-family: "Lucida Grande", "Bitstream Vera Sans", "Verdana";
  font-size: 13px;
  color: #333;
  height: 100%;
  width: 100%;
}

a {
  color: #ddeeee
}

/* Used by account dialog input verification */
.wrong_input {
  background-color: #ff4444;
}


.wait_for_input {
  color: gray;
}

#user_info_holder a:hover {
  background-color: #6688bb;
}

.ui-layout-pane { /* all 'panes' */ 
	border: 1px solid #BBB; 
	padding: 0px; 
	
	/* the following overflow style disables vertical scroll bar */
	overflow: auto;
	overflow-x: hidden;
} 

.ui-layout-resizer { /* all 'resizer-bars' */ 
	background: #DDD; 
} 

.ui-layout-toggler { /* all 'toggler-buttons' */ 
	background: #AAA; 
}

.layout_header {
  background-image: url('/images/header-bg.gif');
  overflow: hidden;
}

#nova-logo {
  margin: 0;
  position: absolute;
  padding: 0;
  left: 50px;
  top: 10px;
}

#global_nav_bar {
  margin: 0;
  position: absolute;
  padding-top: 30px;  /* note that since lavalamp has height 30, setting padding-top to 30 makes the navi-bar in vertical center */
  padding-left: 70px;
  width: 900px;
  height: 90px;
  top: 0px;
  left: 200px;
}

#user_info_holder {
  margin: 0;
  position: absolute;
  display: block;
  top: 0;
  right:0;
  width: 300;
  height: 90;
}

#layout_left_pane {
/* another style: #e6e3ef */
  background-color: #e6e3ef;
}

#layout_center_pane {
/* another style: #656061 */
/*  background-color: #656061; */

}

</style>
<script type="text/javascript">

	var myLayout; // a var is required because this page utilizes: myLayout.allowOverflow() method

	$(document).ready(function () {
	  
		// this layout could be created with NO OPTIONS - but showing some here just as a sample...
		// myLayout = $('body').layout(); -- syntax with No Options
		myLayout = $('body').layout({
		//	reference only - these options are NOT required because are already the 'default'
			closable:				true	// pane can open & close
		,	resizable:				true	// when open, pane can be resized 
		,	slidable:				true	// when closed, pane can 'slide' open over other panes - closes on mouse-out
		, north__size: 90
		, north__resizable: false
		//	some resizing/toggling settings
//		,	north__slidable:		false	// OVERRIDE the pane-default of 'slidable=true'
//		,	north__togglerLength_closed: '100%'	// toggle-button is full-width of resizer-bar
//		,	north__spacing_closed:	20		// big resizer-bar when open (zero height)
//		,	south__resizable:		false	// OVERRIDE the pane-default of 'resizable=true'
//		,	south__spacing_open:	0		// no resizer-bar when open (zero height)
//		,	south__spacing_closed:	20		// big resizer-bar when open (zero height)
		//	some pane-size settings

    <% if not @skip_layout_left_pane %>

		  ,	west__minSize:			200
		  , west__maxSize:      300
		  , west__size:         300
	  
	  <% end %>
		
		<%=
		  if @layout_resize_callback
		    ", onresize_end: " + @layout_resize_callback
		  end
		%>
//		,	east__size:				300
//		,	east__minSize:			200
//		,	east__maxSize:			Math.floor(screen.availWidth / 2) // 1/2 screen width
		});
		
		// TODO ENHANCE use apple style, like Google Chrome's inspector
		$(function() {
      $("#global_nav_bar").lavaLamp({
        fx: "backout",
        speed: 700,
        click: function(event, menuItem) {
//          return false;
        }
      });
    });

 	});
 	
 	var account_dialog;
 	
 	
 	function do_my_account() {
 	  if (account_dialog == null) {
 	    
 	    /* Initialize all settings fields, so nothing was saved when open the dialog again */
 	    function do_init_settings_fields() {
 	      
 	      // trick: unset the focus on fullname input, else the user name is not shown at beginning
 	      $("#account_setting_fullname").blur();
 	      
     	  decorate_field($("#account_setting_fullname"), "<%= current_user.name %>", "wait_for_input");
     	  decorate_field($("#account_setting_email"), "<%= current_user.email %>", "wait_for_input");
     	  
     	  // =============================================
     	  
 	      var np = $("#account_setting_new_password");
        var npc = $("#account_setting_new_password_confirm");
        var oldpwd = $("#account_setting_old_password");
        var opc = $(".account_setting_old_password_container");
        
        np.val("");
        npc.val("");
        oldpwd.val("");
        opc.hide();
        
        function show_old_password_container() {
          if ($.browser.mozilla || $.browser.msie) {
            opc.fadeIn(300);
          } else {
            opc.show();
          }
          $(".account_setting_new_password_container").css("color", "black");
        }
        
        function hide_old_password_container() {
          if ($.browser.mozilla || $.browser.msie) {
            opc.fadeOut(300);
          } else {
            opc.hide();
          }
          $(".account_setting_new_password_container").css("color", "gray");
        }
        
        $("#account_setting_fullname").bind("focus", function() {
     	    if (will_change_account_password() == false) {
     	      hide_old_password_container()
     	    }
     	  });
     	  
     	  $("#account_setting_email").bind("focus", function() {
     	    if (will_change_account_password() == false) {
     	      hide_old_password_container()
     	    }
     	  });
     	  
     	  np.bind("focus", function() {
     	    show_old_password_container();
     	  });
     	  
     	  npc.bind("focus", function() {
     	    show_old_password_container()
     	  });
     	  
     	  np.bind("keypress", function() {
     	    np.removeClass("wrong_input");
     	    npc.removeClass("wrong_input");
     	  });
     	  
     	  npc.bind("keypress", function() {
     	    np.removeClass("wrong_input");
     	    npc.removeClass("wrong_input");
     	  });
     	  
      }
      
      account_dialog = $("#user_account_setting").dialog({
        modal: true,
        width: 560,
        height: $.browser.msie ? 720 : 420, // IE has layout problems
        resizable: false,
        draggable: $.browser.msie == false, // IE has layout problems

        dialogClass: "mac",

        // firefox and IE has displaying bugs
        //hide: ($.browser.mozilla || $.browser.msie) ? "slide" : "puff",
        //show: ($.browser.mozilla || $.browser.msie) ? "slide" : "puff",
        
        // "puff" effect will have wrong layout if opened again
        hide: "slide",
        show: "slide",
        
        title: "Account settings for " + "'<%= current_user.login %>'",
        
        close: do_init_settings_fields,
        open: do_init_settings_fields,
        
        buttons: {
          "OK": function(e) {
            if (will_change_account_info() == false) {
              $(this).dialog("close");
              return;
            }
            if (do_account_setting_validate() == false) {
              return;
            }
            e.currentTarget.innerHTML = "Please wait";
            show_message("Updating your account info");
            
            
            // TODO send Ajax message to change user info
            // close if success
            
            $(this).dialog("close");
            e.currentTarget.innerHTML = "OK";
          },
          "Close": function() {
            $(this).dialog("close");
            do_init_settings_fields();
          }
        }
      });
 	  }
 	  account_dialog.dialog("open");
  }
  
  function show_message(message) {
    if ($.browser.msie) {
      alert(message);
    } else {
      $("#jGrowl-Notification").jGrowl(message);
    }
  }
  
  function will_change_account_password() {
    // judge if going to change account password
    var np = $("#account_setting_new_password");
    var npc = $("#account_setting_new_password_confirm");
    return (np.val() != null && np.val() != "") || (npc.val() != null && npc.val() != "");
  }
  
  function will_change_account_info() {
    return (will_change_account_password() || 
            (has_classname($("#account_setting_fullname"), "wait_for_input") == false) || 
            (has_classname($("#account_setting_email"), "wait_for_input") == false)
           );
  }
  
  function do_account_setting_validate() {
    var fullname = $("#account_setting_fullname");
    var email = $("#account_setting_email");
    
    if (fullname.val() != null && fullname.val().length > 100) {
      show_message("Full name cannot exceed 100 characters");
      fullname.addClass("wrong_input");
      return false;
    }
    
    if (email.val() == null || email.val().length < 6 || email.val().length > 40) {
      show_message("Email address should have 6~40 characters");
      email.addClass("wrong_input");
      return false;
    }
    
    
    var email_regex = /^([A-Za-z0-9\-\.])+\@([A-Za-z0-9\-\.])+\.([A-Za-z]{2,4})$/;
    if (email_regex.test(email.val()) == false) {
      show_message("Invalid email address");
      email.addClass("wrong_input");
      return false;
    }
    
    if (will_change_account_password()) {
      // do password checking
      
      var np = $("#account_setting_new_password");
      var npc = $("#account_setting_new_password_confirm");
      var op = $("#account_setting_old_password");
      
      if (np.val() == null || np.val().length < 6 || np.val().length > 40) {
        show_message("Password should have 6~40 characters");
        np.addClass("wrong_input");
        return false;
      }
      
      if (npc.val() != np.val()) {
        show_message("Your password does not match");
        npc.addClass("wrong_input");
        return false;
      }
      
      if (op.val() == null || op.val() == "") {
        show_message("Old password is required");
        op.addClass("wrong_input");
        return false;
      }
      
    }
    
    return true;
  }
  
  function has_classname(elem, kls_name) {
    var elem_kls_arr = elem.attr("class").split(" ");
    for (i = 0; i < elem_kls_arr.length; i++) {
      if (elem_kls_arr[i] == kls_name) {
        return true;
      }
    }
    return false;
  }
  
  
  // jQuery version
  function decorate_field(field, default_text, default_class) {
    field.val(default_text);
    field.addClass(default_class);

    field.bind("focus", function() {
      if (has_classname(field, default_class)) {
        field.val(""); // clear default data, wait for user's input
      }
    });
    
    field.bind("keypress", function(e) {
      if (field.val() != "" || e.charCode != 0) {
        field.removeClass(default_class);
        field.removeClass("wrong_input");
      }
    });
    
    field.bind("blur", function() {
      if (field.val() == "") {
        field.val(default_text);
        field.addClass(default_class);
      }
    });
    
  }
 	
</script>

<%= yield :layout_style_and_scripts %>

</head>
<body scroll="no">


<div class="ui-layout-north layout_header">

  <img src="/images/logo-small.png" id="nova-logo"></img>
  <ul class="lavaLampWithImage" id="global_nav_bar">
  
<%
  ## a helper function to render navi-bar html text
  def nav_bar_item text, link
    html = "<li "
    require 'pp'
    if text == @nav_bar_current
      html += 'class="current"'
    end
    html += '><a href="' + link + '">' + text + "</a></li>"
    return html
  end
%>

<% if current_user.in_group? "root" %>
  <%= nav_bar_item "Home", "/app/home" %>
  <%= nav_bar_item "Users", "/app/users" %>
  <%=
    ## root user could manage both virutal machine and physical machine
    nav_bar_item "Machines", "/app/root_machines"
  %>
  <%=
    ## root user could manage networks and vm images, and browse KFS directory
    nav_bar_item "Resources", "/app/root_resources"
  %>
  <%= 
    ## system settings such as KFS settings, and shutting down server
    nav_bar_item "System Settings", "/app/root_system_settings"
  %>
  
<% elsif current_user.in_group? "admin" %>
  <%= nav_bar_item "Home", "/app/home" %>
  <%= nav_bar_item "Users", "/app/users" %>
  <%=
    ## admin user could manage all virutal machines, but no physical machines
    nav_bar_item "Machines", "/app/admin_machines"
  %>
  <%=
    ## admin user could manage public virtual machine images
    nav_bar_item "Resources", "/app/admin_resources"
  %>
  
<% else %>
  <%= nav_bar_item "Home", "/app/home" %>
  <%= nav_bar_item "Machines", "/app/user_machines" %>
  <%= nav_bar_item "Resources", "/app/user_resources" %>
  <%= nav_bar_item "Groups", "/app/user_groupss" %>
<% end %>
    
  </ul>
  
  <div id="user_info_holder">
  
<% if current_user.in_group? "root" %>
    <img src="/images/user_64_red.png" style="position:relative;top:13px"></img>
<% elsif current_user.in_group? "admin" %>
    <img src="/images/user_64_yellow.png" style="position:relative;top:13px"></img>
<% else  %>
    <img src="/images/user_64_blue.png" style="position:relative;top:13px"></img>
<% end %>

    <div style="position:relative;top:-48px;left:70px">
    
<% if current_user.in_group? "root" %>
  System Administrator
<% elsif current_user.in_group? "admin" %>
  Administrator
<% else  %>
  User
<% end %>

    '<%=h current_user.login %>'<br />
    <a href="#" onclick="do_my_account()">My account<br />
    <%= link_to "Log out", logout_url %>
    </div>
  </div>
  
</div>

<% if not @skip_layout_left_pane %>

  <div class="ui-layout-west" id="layout_left_pane">
    <%= yield :layout_left_frame %>
  </div>

<% end %>

<div class="ui-layout-center" id="layout_center_pane">
  <%= yield :layout_center_frame %>
</div>


<div id="user_account_setting" style="display:none;">
<p align="center">
  <table>
    <tr>
      <td>Full Name</td>
      <td><img src="/images/spacer.gif" width=40 height=40></td>
      <td><input type="text" id="account_setting_fullname" /></td>
    </tr>

    <tr>
      <td>Email Address</td>
      <td><img src="/images/spacer.gif" width=40 height=40></td>
      <td><input type="text" id="account_setting_email" /></td>
    </tr>
    
    <tr>
      <td colspan=3 style="height:30px">
        <hr>
      </td>
    </tr>
    
    <tr style="color:gray" class="account_setting_new_password_container">
      <td>New Password</td>
      <td><img src="/images/spacer.gif" width=40 height=40></td>
      <td><input type="password" id="account_setting_new_password" /></td>
    </tr>
    
    <tr style="color:gray" class="account_setting_new_password_container">
      <td>Confirm New Password</td>
      <td><img src="/images/spacer.gif" width=40 height=40></td>
      <td><input type="password" id="account_setting_new_password_confirm" /></td>
    </tr>

    <tr>
      <td><div class="account_setting_old_password_container">Old Password *</td>
      <td><img src="/images/spacer.gif" width=40 height=40></td>
      <td><input class="account_setting_old_password_container" type="password" id="account_setting_old_password" /></td>
    </tr>
    
    <tr>
      <td colspan=3>
        <div class="account_setting_old_password_container">
          <font style="font-size:10px">Old password is required if you want to change it.</font>
        </div>
      </td>
    </tr>
  </table>
</p>  
</div>

<div id="jGrowl-Notification" class="bottom-right"></div>

</body></html>


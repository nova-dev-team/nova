<html>
<head>
<title>Nova platform</title>

<link href="/stylesheets/custom_buttons.css" rel="stylesheet" type="text/css" />
<link href="/stylesheets/iphone_checkbox.jquery/style.css" rel="stylesheet" type="text/css" />
<link href="/stylesheets/jquery.notice.css" rel="stylesheet" type="text/css" />
<link href="/stylesheets/thickbox.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="/javascripts/jquery-1.3.2.min.js"> </script>
<script type="text/javascript" src="/javascripts/jquery.notice.js"> </script>
<script type="text/javascript" src="/javascripts/thickbox-compressed.js"> </script>
<script type="text/javascript" src="/javascripts/iphone_checkbox.jquery.js"> </script>

<style type="text/css" media="screen">
/*
  IE png fix
*/
img, div {
  behavior: url(/stylesheets/iepngfix.htc)
}

body {
  margin: 0;
  margin-bottom: 25px;
  padding: 0;
  background-color: #ddeeee;
  font-family: "Lucida Grande", "Bitstream Vera Sans", "Verdana";
  font-size: 13px;
  color: #333;
  overflow: hidden;
}

input, select, textarea {
  margin: 5px 0;
  padding: 5px;
  color: #6A6969;
  border-width: 1px;
  border-style: solid;
  border-color: #D4D4D4 #EBEBEB #EBEBEB #D4D4D4; 	
  font: 11px 'Lucida Grande', Verdana, Helvetica, sans-serif;
  height: 18pt;
}

input {
  width: 100pt;
}

#login_panel_text {
  font: 14px 'Lucida Grande', Verdana, Helvetica, sans-serif;
}

a {
  color: #ddeeee
}

a:hover {
  background-color: #6688bb;
}

/* NOTE IE has problems rendering the border, since its width is included in the div's width */
/* I have to use some tricks to fix this */
/* ref: http://www.webcredible.co.uk/user-friendly-resources/css/internet-explorer.shtml, 090630 */

#page {
  position: absolute;
  background-image: url(/images/bg.jpg);
  width: 780px; /* IE fix. Original value was 750. 780 = 750 + 2 * 15 (border width) */
  height: 530px; /* IE fix. Original value was 500. 530 = 500 + 2 * 15 (border width) */
  border: 15px white solid;
}

html>body #page {
  width: 750px; /* IE fix */
  height: 500px; /* IE fix */
}

#login_panel {
  position: relative;
  left: -20px;
  top: +20px;
}

#logo_holder {
  position: absolute;
}

#bottom_line {
  position: absolute;
  height: 30px;
  color: #ddeeee;
}

.wait_for_input {
  color: gray;
}

.wrong_input {
  background-color: #ff4444;
}

.message_title {
  font-family: "Lucida Grande", "Bitstream Vera Sans", "Verdana";
  font-size: 15px;
  font-weight: bold;
  color: white;
}

.message_body {
  font-family: "Lucida Grande", "Bitstream Vera Sans", "Verdana";
  font-size: 11px;
  color: white;
}

</style>
<script type="text/javascript">

function do_message(type, title, msg) {
  jQuery.noticeAdd({
    text: "<table><tr><td rowspan='2' valign='top'><img src='/images/" + type + ".png'></td><td class='message_title'>" + title + "</td></tr><tr><td class='message_body'>" + msg + "</td></tr></table>"
  });
}

function do_login() {
  var login_field = $('#login');
  var password_field = $('#password');
  
  if (login_field.hasClass("wait_for_input")) {
    login_field.addClass("wrong_input");
    do_message("failure", "Not enough information", "Please provide your user ID!");
    return;
  }
  if (password_field.hasClass("wait_for_input")) {
    password_field.addClass("wrong_input");
    do_message("failure", "Not enough information", "Please provide your password!");
    return;
  }

  $.ajax({
    url: '/sessions/create.json',
    type: 'POST',
    data: {
      login: login_field.val(),
      password: password_field.val()
    },
    dataType: 'json',
    success: function(result) {
      if (result.success) {
        window.location = '/';
      } else {
        do_message("failure", "Login failed", result.message);
      }
    },
    failure: function() {
      do_message("failure", "Connection failed", "Please check your network connection!");
    }
  });
}

function getWindowWidth() {
  return window.innerWidth || (window.document.documentElement.clientWidth || window.document.body.clientWidth);
}

function getWindowHeight() {
  return window.innerHeight || (window.document.documentElement.clientHeight || window.document.body.clientHeight);
}

/* a hack to fix resizing bug 090630 */
var _page_width;
var _page_height;

// put the login panel to the center
function do_layout() {  
  var page_border_width = 15;
  var panel = $("#page");

  /* a hack to fix resizing bug 090630 */    
  var _resizing_fix_090630 = false;
  
  if (_page_width == null) {
    _page_width = panel.width();
  }
  if (_page_height == null) {
    _page_height = panel.height();
  }
  if (_page_width != panel.width() || _page_height != panel.height()) {
    _resizing_fix_090630 = true;
  }
  
  var left_origin = (getWindowWidth() - panel.width()) / 2 - page_border_width;
  var top_origin = (getWindowHeight() - panel.height()) / 2 - page_border_width;

  // FIX on 090909: when browser window is too small, don't do center layout
  if (left_origin < 0 || top_origin < 0) {
    left_origin = Math.max(0, left_origin);
    top_origin = Math.max(0, top_origin);
  }
  
  if (_resizing_fix_090630) {
    left_origin += page_border_width;
    top_origin += page_border_width;
  }
  
  panel.css("left", left_origin);
  panel.css("top", top_origin);
  var logo = $("#logo_holder");
  logo.css("left", (left_origin + 50));
  logo.css("top", (top_origin + 30));
  
  var bottom = $("#bottom_line");
  var bottom_margin = 10;
  
  if (_resizing_fix_090630) {
    bottom.css("width", (panel.width() - (bottom_margin + page_border_width) * 2));
    bottom.css("left", (left_origin + page_border_width + bottom_margin));
    bottom.css("top", (top_origin + panel.height() + page_border_width - bottom.height() - 2 * page_border_width));
  } else {
    bottom.css("width", (panel.width() - bottom_margin * 2));
    bottom.css("left", (left_origin + page_border_width + bottom_margin));
    bottom.css("top", (top_origin + panel.height() + page_border_width - bottom.height()));
  }
}

function decorate_fields(fields, default_text, default_class) {
  $.each(fields, function(idx, field) {
    field.val(default_text);
    field.addClass(default_class);

    field.focus(function() {
      if (field.hasClass(default_class)) {
        field.val(""); // clear default data, wait for user's input
      }
    });

    field.keypress(function(e) {
      if (field.val() != "" || e.charCode != 0) {
        $.each(fields, function(idx2, field2) {
          field2.removeClass(default_class);
          field2.removeClass("wrong_input");
        });
      }
    });

    // on lost focus, check if has user input
    field.blur(function() {
      if (field.val() == "") {
        field.val(default_text);
        field.addClass(default_class);
      }
    });
  });
}

function validate_signup() {
  var signup_user_id = $("#signup_user_id");
  var signup_password = $("#signup_password");
  var signup_password_confirm = $("#signup_password_confirm");
  var signup_email = $("#signup_email");
  var signup_verification = $("#signup_verification");
  var signup_fullname = $("#signup_fullname");
  
  function signup_error(msg) {
    do_message("failure", "Incorrect signup information", msg);
  }
  
  if (signup_user_id.hasClass("wait_for_input")) {
    signup_error("Please provide a user ID");
    signup_user_id.addClass("wrong_input");
    return false;
  }
  
  if (signup_user_id.val() == "" || signup_user_id.val().length < 3 || signup_user_id.val().length > 40) {
    signup_error("User ID should have 3~40 characters");
    signup_user_id.addClass("wrong_input");
    return false;
  }
  
  var user_id_regex = /^([a-z])+([a-z0-9_\.])*$/;
  if (user_id_regex.test(signup_user_id.val()) == false) {
    signup_error("User ID should only contain a-z, 0-9, '.' and '_'. And it must start with a-z.");
    signup_user_id.addClass("wrong_input");
    return false;
  }
  
  if (signup_password.hasClass("wait_for_input")) {
    signup_error("Please provide a password");
    signup_password.addClass("wrong_input");
    return false;
  }
  
  if (signup_password.val() == "" || signup_password.val().length < 6 || signup_password.val().length > 40) {
    signup_error("Password should have 6~40 characters");
    signup_password.addClass("wrong_input");
    return false;
  }
  
  if (signup_password.val() != signup_password_confirm.val()) {
    signup_error("Your password does not match");
    signup_password.addClass("wrong_input");
    signup_password_confirm.addClass("wrong_input");
    return false;
  }
  
  if (signup_fullname.val() != "" && signup_fullname.val().length > 100) {
    signup_error("Full name cannot exceed 100 characters");
    signup_fullname.addClass("wrong_input");
    return false;
  }
  if (signup_email.hasClass("wait_for_input")) {
    signup_error("Please provide your email address");
    signup_email.addClass("wrong_input");
    return false;
  }
  
  if (signup_email.val() == "" || signup_email.val().length < 6 || signup_email.val().length > 40) {
    signup_error("Email address should have 6~40 characters");
    signup_email.addClass("wrong_input");
    return false;
  }
  
  var email_regex = /^([A-Za-z0-9\-\.])+\@([A-Za-z0-9\-\.])+\.([A-Za-z]{2,4})$/;
  if(email_regex.test(signup_email.val()) == false) {
    signup_error("Invalid email address");
    signup_email.addClass("wrong_input");
    return false;
  }
  
  return true;
}

function send_signup() {
  if (validate_signup() == false)
    return false;
  
  // prevent sending twice when user double-click "sign up" button
  $("#btn_send_signup").onclick = function() {};

  var signup_user_id = $("#signup_user_id");
  var signup_password = $("#signup_password");
  var signup_password_confirm = $("#signup_password_confirm");
  var signup_email = $("#signup_email");
  var signup_verification = $("#signup_verification");
  var signup_admin = $("#signup_admin");

  var signup_fullname = "";
  if ($("#signup_fullname").hasClass("wait_for_input") == false) {
    signup_fullname = $("#signup_fullname").val();
  }

  var privilege = "normal";
  if (signup_admin.checked) {
    privilege = "admin";
  }

  $.ajax({
    url: '/users/create.json',
    type: 'POST',
    data: {
      login: signup_user_id.val(),
      password: signup_password.val(),
      password_confirmation: signup_password_confirm.val(),
      email: signup_email.val(),
      name: signup_fullname,
      privilege: privilege
    },
    dataType: 'json',
    success: function(result) {
      if (result.success) {
        do_message("success", "Sign up success", result.message);
      } else {
        do_message("failure", "Sign up failed", result.message);
      }
    },
    failure: function() {
      do_message("failure", "Connection failed", "Please check your network connection!");
    }
  });
  return true;
}

var iphone_style_for_admin_chkbox = false;

window.onload = function() {
  window.onresize = do_layout;

  do_layout();
  $("#page").show(); // prevents blinking, show after layout
  $("#logo_holder").show();
  $("#bottom_line").show();
  
  if ($.browser.msie) {
    // for IE, layout twice to fix border-drawing bug  
    do_layout();
  }

  // login & password
  decorate_fields([$('#login')], "User ID", "wait_for_input");
  decorate_fields([$('#password')], "password", "wait_for_input");

  // signup panel
  decorate_fields([$("#signup_user_id")], "3~20 characters", "wait_for_input");
  decorate_fields([$("#signup_password"), $("#signup_password_confirm")], "", "wait_for_input");
  decorate_fields([$("#signup_email")], "6~40 characters", "wait_for_input");
  decorate_fields([$("#signup_fullname")], "<= 40 characters", "wait_for_input");

  // apply iphone style each time, so that the iphone checkbox has correct geometry
  $("#signup_window_link").click(function(){
    if (iphone_style_for_admin_chkbox == false) {
      $("#signup_admin").iphoneStyle({
        checkedLabel: "YES",
        uncheckedLabel: "NO"
      });
      iphone_style_for_admin_chkbox = true;
    }
  });
}
</script>
</head>
<body scroll="no">

<!-- div #page set to "display:none". It will be shown by javascript. This is intended to reduce flickering. -->
<div id="page" style="display: none;">
  <div id="login_panel" align='right'>
  <table>
  <tr>
  <td>
    <div>
    <input id="login" name="login" type="text" />
    <input id="password" name="password" type="password" />
    </div>
  </td>
  <td>
    <div id="login_panel_text">
    &nbsp;&nbsp;
    <a href='#' onclick="do_login(); return false">Login</a>
    &nbsp;
    <a href="#TB_inline?height=360&width=460&inlineId=signup_form" id="signup_window_link" class="thickbox">Sign Up</a>
    </div>
  </td>
  </tr>
  </table>
  </div>
</div>

<div id="logo_holder" style="display: none;">
  <img src="/images/logo.png" />
</div>

<div id="bottom_line" style="display: none">
  <div style="position:absolute">
    &copy;2010 <a href="mailto:santa1987@gmail.com">Santa Zhang</a> &amp; <a href="mailto:herokuankuan@gmail.com">Huang Gang</a>
  </div>
  <div align="right" style="font-size:9px; vertical-align:center;">
    <%= File.read "#{RAILS_ROOT}/../VERSION" %> &nbsp;&nbsp;
  </div>
</div>

<div id="signup_form" style="display: none;">
  <p align='center'>
    <table>
      <tr>
        <td>User ID *</td>
        <td><img src='/images/spacer.gif' width=40 height=40></td>
        <td><input type='text' id='signup_user_id' /></td>
      </tr>
      <tr>
        <td>Password *</td>
        <td><img src='/images/spacer.gif' width=40 height=40></td>
        <td><input type='password' id='signup_password' /></td>
      </tr>
      <tr>
        <td>Confirm Password *</td>
        <td><img src='/images/spacer.gif' width=40 height=40></td>
        <td><input type='password' id='signup_password_confirm' /></td>
      </tr>
      <tr>
        <td>Email Address *</td>
        <td><img src='/images/spacer.gif' width=40 height=40></td>
        <td><input type='text' id='signup_email' /></td>
      </tr>
      <tr>
        <td>Full Name</td>
        <td><img src='/images/spacer.gif' width=40 height=40></td>
        <td><input type='text' id='signup_fullname' /></td>
      </tr>
      <tr>
        <td>Sign up as administrator?</td>
        <td><img src='/images/spacer.gif' width=40 height=40></td>
        <td><input type='checkbox' id='signup_admin' /></td>
      </tr>
      <tr>
        <td colspan=3>
          <font style='font-size:10px'>
          Fields with * is required<br />
          Allowed user id characters include: a-z, 0-9, '.' and '_' (must start with a-z)<br />
          Password should have length 6~40 characters
          </font>
        </td>
      </tr>
    </table>
  </p>
  <p align='center'>
    <button id='btn_send_signup' type='button' class='btn' onclick='send_signup() && tb_remove()'><span><span>Sign up!</span></span></button>
  </p>
</div>

</body>
</html>

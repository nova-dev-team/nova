# Add your own tasks in files placed in lib/tasks ending in .rake,
# for example lib/tasks/capistrano.rake, and they will automatically be available to Rake.

require(File.join(File.dirname(__FILE__), 'config', 'boot'))

require 'rake'
require 'rake/testtask'
require 'rake/rdoctask'

require 'tasks/rails'

require 'fileutils'

namespace :nova do
  namespace :worker do

    def do_init
      `rake db:migrate RAILS_ENV=production`
      `rake db:migrate RAILS_ENV=development`
      `rake db:migrate:reset RAILS_ENV=production`
      `rake db:migrate:reset RAILS_ENV=development`
      `rake db:fixtures:load RAILS_ENV=production`
      `rake db:fixtures:load RAILS_ENV=development`
    end

    desc "Initialize system"
    task :init do
      do_init
    end

    desc "Start Nova worker (Development mode)"
    task :devstart do
      puts "Starting Nova worker in *Development* mode..."
      `script/server -d`
      FileUtils.mkdir_p "#{RAILS_ROOT}/tmp"
      `hostname > #{RAILS_ROOT}/tmp/hostname`
    end

    def do_start
      puts "TODO"
    end

    desc "Start Nova worker (Release mode)"
    task :start do
      puts "Starting Nova worker in *Release* mode..."
      do_start
    end

    desc "Stop Nova worker"
    task :stop do
      if File.exists? "tmp/pids/server.pid"
        puts "Found tmp/pids/server.pid file"
        puts "Nova worker server pid = #{File.read 'tmp/pids/server.pid'}"
        puts "Terminating..."
        `kill #{File.read "tmp/pids/server.pid"}`
      end
    end

    desc "Reset system, remove all Vmachines, cleanup all resource"
    task :reset do
      require 'rubygems'
      require 'libvirt'
      
      `Rake nova:worker:stop`

      virt_conn = Libvirt::open("qemu:///system")
      virt_conn.list_defined_domains.each do |domain_name|
        puts "Destroying domain '#{domain_name}'"
        begin
          dom = virt_conn.lookup_domain_by_name domain_name
          puts "UUID=#{dom.uuid}"
          begin
            dom.destroy
          rescue
            # do nothing here
          end
          dom.undefine
        rescue
          next
        end
      end

      `rm tmp/work_site -rf`
      do_init
      do_start

    end
  end
end

